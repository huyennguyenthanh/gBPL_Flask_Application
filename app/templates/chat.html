<body>
    Room : {{ session['room'] }}
    Between : {{ current_user.name }} and {{ to_user.name}}
    <br>
    <textarea id="chat" cols="70" rows="10" placeholder="No messages yet. Start one..."></textarea>
    <div class="Chat">
        <label for="send">Message</label>
        <input type="text" id="myInput" placeholder="Enter your message"></text>
        <button type="button" id="send" class="btn btn-success">SEND</button>
    </div>
    <button type="button" class="btn btn-danger" onclick=leave_room()>Leave this Chat</button>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.2.0/socket.io.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"
        integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <script>
        var socket;
        $(document).ready(function(){
            socket = io.connect('http://' + document.domain + ':' + location.port + '/chat' );
            
            socket.on('connect', function() {
                connected = true;
                socket.emit('join', {});
            });
            socket.on('disconnect', () => {
                connected = false;
            });
            socket.on('status', function(data) {
                    $('#chat').val($('#chat').val() + '<' + data.msg + '>\n');
                    $('#chat').scrollTop($('#chat')[0].scrollHeight);
                });
            socket.on('message', function(data) {
                
                console.log(data)
                    $('#chat').val($('#chat').val() + data.msg + '\n');
                    $('#chat').scrollTop($('#chat')[0].scrollHeight);
                });

       

            var callback = function() {
                
                var text = $('#myInput').val();
                console.log(text)
                $('#myInput').val('');
                socket.emit('text', {msg: text});
            }
            $('#myInput').keypress(function(e) {
                    if(event.which == '13'){
                        callback()   
                    }
            });
            $('#send').click(callback)
        });
        function leave_room() {
                data = {
                    
                    'event': 'leave',
                    'room': "{{ session['room'] }}",
                    'msg':  "The friend leave the chat."
                }
                socket.emit('left', data, function() {
                    socket.disconnect();
                    // go back to the login page
                    window.location.href = "{{ url_for('review_result', to_user=to_user) }}";
                });
            }
        // $("#btnSendMsg").click(function () {
        //     if (!connected) {
        //         alert('No socket connection available!');
        //     } else {
        //         msg = $("#send").val().trim();
        //         addMessage("YOU", msg);
        //         $("#send").val('');
                
        //         data = {
        //             'event': 'chat',
        //             'room': $("#roomname").val(),
        //             'text': msg
        //         };
        //         socks.emit('chat', data);
        //         }
        //     }
        // });
        // $("#btnLeave").click(function () {
        //     user = $("#username").val().trim();
        //     room = $("#roomname").val().trim();
        //     if (user === '' || room === '') {
        //         alert('Both room and user names are mandatory');
        //     } else {
        //         // Validate
        //         jsn = {
        //             'event': 'leave',
        //             'user': user,
        //             'room': room
        //         };
        //         socks.emit('chat', jsn);
        //         $("#btnJoin").prop("disabled", false);
        //         $("#username").prop("readonly", false);
        //         $("#roomname").prop("readonly", false);
        //     }
        // });
    </script>
</body>